# 激活虚拟环境 .venv\Scripts\Activate.ps1
# ansible-playbook -i inventory.ini playbook.yml
---
- name: 部署 OneTapWebsite 应用
  hosts: all
  become: yes
  vars:
    project_dir: /opt/OneTapWebsite-with-Ansible-Docker
    repo_url: https://github.com/Hoalint/OneTapWebsite-with-Ansible-Docker.git
    image_name: onetap-website:latest
    http_port: 8080

  collections:
    - community.docker

  tasks:
    # 1. 安装 Docker（根据操作系统）
    - name: 安装 Docker (CentOS)
      block:
        - name: 安装依赖包
          yum:
            name:
              - yum-utils
              - device-mapper-persistent-data
              - lvm2
            state: present

        - name: 添加 Docker 官方仓库
          get_url:
            url: https://download.docker.com/linux/centos/docker-ce.repo
            dest: /etc/yum.repos.d/docker-ce.repo

        - name: 安装 Docker CE
          yum:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present

        - name: 启动并启用 Docker 服务
          systemd:
            name: docker
            state: started
            enabled: yes

      when: ansible_os_family == "RedHat"

    - name: 安装 Docker (Ubuntu)
      block:
        - name: 安装依赖包
          apt:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - software-properties-common
            state: present
            update_cache: yes

        - name: 添加 Docker GPG 密钥
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: 添加 Docker 仓库
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: 安装 Docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present
            update_cache: yes

        - name: 启动并启用 Docker 服务
          systemd:
            name: docker
            state: started
            enabled: yes

      when: ansible_distribution == "Ubuntu"

    - name: 安装 Docker (Debian)
      block:
        - name: 安装依赖包
          apt:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg
            state: present
            update_cache: yes

        - name: 添加 Docker GPG 密钥
          apt_key:
            url: https://download.docker.com/linux/debian/gpg
            state: present

        - name: 添加 Docker 仓库
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state: present

        - name: 安装 Docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present
            update_cache: yes

        - name: 启动并启用 Docker 服务
          systemd:
            name: docker
            state: started
            enabled: yes

      when: ansible_distribution == "Debian"

    # 2. 安装 Docker Compose
    - name: 安装 Docker Compose (CentOS)
      block:
        - name: 下载 Docker Compose v2
          get_url:
            url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
            dest: /usr/local/bin/docker-compose
            mode: '0755'

        - name: 创建软链接
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link

      when: ansible_os_family == "RedHat"

    - name: 安装 Docker Compose (Ubuntu)
      block:
        - name: 安装 docker-compose-plugin
          apt:
            name: docker-compose-plugin
            state: present
            update_cache: yes

      when: ansible_distribution == "Ubuntu"

    - name: 安装 Docker Compose (Debian)
      block:
        - name: 下载 Docker Compose v2
          get_url:
            url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
            dest: /usr/local/bin/docker-compose
            mode: '0755'

        - name: 创建软链接
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link

      when: ansible_distribution == "Debian"

    # 3. 安装 Git
    - name: 安装 Git
      package:
        name: git
        state: present

    # 4. 克隆项目代码
    - name: 克隆项目仓库
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        clone: yes
        update: yes

    # 5. 复制 .env 文件（从本地到目标主机）
    - name: 复制 .env 文件
      copy:
        src: .env
        dest: "{{ project_dir }}/.env"
        mode: '0644'

    # 6. 构建 Docker 镜像
    - name: 构建应用镜像
      docker_image:
        build:
          path: "{{ project_dir }}"
        name: "{{ image_name }}"
        source: build
        state: present

    # 7. 启动 Docker Compose 服务
    - name: 启动 Docker Compose 服务
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        state: present
        recreate: "always"

    # 8. 配置防火墙（开放8080端口）
    - name: 开放防火墙端口 (CentOS/firewalld)
      firewalld:
        port: "{{ http_port }}/tcp"
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == "RedHat"

    - name: 开放防火墙端口 (Ubuntu/ufw)
      ufw:
        rule: allow
        port: "{{ http_port }}"
        proto: tcp
      when: ansible_os_family == "Debian"

    # 9. 等待应用就绪
    - name: 等待应用启动完成
      wait_for:
        port: "{{ http_port }}"
        host: "{{ ansible_default_ipv4.address }}"
        timeout: 60
        delay: 5

    # 10. 验证应用可访问
    - name: 验证应用响应
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ http_port }}"
        return_content: yes
        status_code: 200
      register: webpage
      until: webpage.status == 200
      retries: 10
      delay: 5

    - name: 显示部署成功信息
      debug:
        msg: "OneTapWebsite 已成功部署！访问地址：http://{{ ansible_default_ipv4.address }}:{{ http_port }}"
